#!/usr/bin/env bash
# Run a query against the PostgreSQL 17 replica on hal9000
# Usage: pg17-query "SELECT ..." [database]
set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: pg17-query \"SELECT ...\" [database]"
    echo "Example: pg17-query \"SELECT count(*) FROM users\" mydb"
    exit 1
fi

QUERY="$1"
DATABASE="${2:-}"

if [[ -n "$DATABASE" ]]; then
    ssh hal9000 "sudo -u postgres psql -h localhost -p 5439 -d '$DATABASE' -c \"$QUERY\""
else
    ssh hal9000 "sudo -u postgres psql -h localhost -p 5439 -c \"$QUERY\""
fi
