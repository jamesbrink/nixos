name: Check Upstream Runner Image

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

env:
  UPSTREAM_IMAGE: ghcr.io/actions/actions-runner:latest

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current upstream digest from Dockerfile
        id: current
        run: |
          # Extract the current base image from Dockerfile
          BASE_IMAGE=$(grep '^FROM ghcr.io/actions/actions-runner' containers/github-runner-full/Dockerfile | head -1 | awk '{print $2}')
          echo "base_image=$BASE_IMAGE" >> $GITHUB_OUTPUT
          echo "Current base image: $BASE_IMAGE"

      - name: Get latest upstream digest
        id: latest
        run: |
          # Get the digest of the latest upstream image
          DIGEST=$(docker buildx imagetools inspect ${{ env.UPSTREAM_IMAGE }} --format '{{json .Manifest}}' | jq -r '.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "Latest upstream digest: $DIGEST"

      - name: Get current image digest (if pinned)
        id: check_pinned
        run: |
          CURRENT_IMAGE="${{ steps.current.outputs.base_image }}"
          if [[ "$CURRENT_IMAGE" == *"@sha256:"* ]]; then
            CURRENT_DIGEST=$(echo "$CURRENT_IMAGE" | sed 's/.*@//')
            echo "current_digest=$CURRENT_DIGEST" >> $GITHUB_OUTPUT
            echo "is_pinned=true" >> $GITHUB_OUTPUT
            echo "Image is pinned to: $CURRENT_DIGEST"
          else
            echo "is_pinned=false" >> $GITHUB_OUTPUT
            echo "current_digest=" >> $GITHUB_OUTPUT
            echo "Image is not pinned (uses :latest tag)"
          fi

      - name: Check if update needed
        id: needs_update
        run: |
          CURRENT="${{ steps.check_pinned.outputs.current_digest }}"
          LATEST="${{ steps.latest.outputs.digest }}"

          if [[ "${{ steps.check_pinned.outputs.is_pinned }}" == "true" ]]; then
            if [[ "$CURRENT" != "$LATEST" ]]; then
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "ğŸ”„ Upstream image has been updated!"
              echo "  Current: $CURRENT"
              echo "  Latest:  $LATEST"
            else
              echo "needs_update=false" >> $GITHUB_OUTPUT
              echo "âœ… Image is up to date"
            fi
          else
            # Always rebuild if not pinned (using :latest tag)
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Image uses :latest tag - will rebuild to get latest upstream changes"
          fi

      - name: Update Dockerfile with pinned digest
        if: steps.needs_update.outputs.needs_update == 'true'
        run: |
          LATEST_DIGEST="${{ steps.latest.outputs.digest }}"
          NEW_IMAGE="${{ env.UPSTREAM_IMAGE }}@${LATEST_DIGEST}"

          # Update FROM line in Dockerfile
          sed -i "s|FROM ghcr.io/actions/actions-runner.*|FROM ${NEW_IMAGE}|" containers/github-runner-full/Dockerfile

          echo "Updated Dockerfile to use: $NEW_IMAGE"

      - name: Create Pull Request
        if: steps.needs_update.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(runner): update upstream actions-runner image

            Updates base image to latest upstream digest.

            Previous: ${{ steps.check_pinned.outputs.current_digest }}
            Latest: ${{ steps.latest.outputs.digest }}

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>
          branch: update-runner-upstream
          delete-branch: true
          title: "chore(runner): update upstream actions-runner image"
          body: |
            ## ğŸ”„ Upstream Runner Image Update

            The upstream `ghcr.io/actions/actions-runner:latest` image has been updated.

            **Changes:**
            - Previous digest: `${{ steps.check_pinned.outputs.current_digest }}`
            - Latest digest: `${{ steps.latest.outputs.digest }}`

            **Next Steps:**
            1. Review the changes
            2. Merge this PR to trigger a new build
            3. After the build completes, upgrade the K8s runners using:
               ```bash
               cd k8s/quantierra-github-runners
               ./upgrade-runner-image.sh
               ```

            **Upstream Release Notes:**
            See https://github.com/actions/runner/releases for details on what changed.

            ---

            ğŸ¤– Auto-generated by the `check-upstream-runner` workflow
          labels: |
            dependencies
            automated
            runner-image

      - name: Summary
        run: |
          if [[ "${{ steps.needs_update.outputs.needs_update }}" == "true" ]]; then
            echo "âœ… Created PR to update upstream image"
            echo "ğŸ“ PR will trigger a new build on merge"
          else
            echo "âœ… No update needed - image is current"
          fi
