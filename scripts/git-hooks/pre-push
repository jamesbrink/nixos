#!/usr/bin/env bash
set -euo pipefail

# Pre-push hook to ensure private submodules are pushed before main repo
# Install with: cp scripts/git-hooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "Pre-push: Checking submodules..."

# Critical private submodules that must stay in sync
CRITICAL_SUBMODULES=("secrets" "mikrotik-terraform")

NEEDS_PUSH=0

for submodule in "${CRITICAL_SUBMODULES[@]}"; do
    if [ -d "$submodule" ]; then
        pushd "$submodule" > /dev/null

        # Check if it's a git repo
        if git rev-parse --git-dir > /dev/null 2>&1; then
            # Check for unpushed commits
            UNPUSHED=$(git rev-list --count "@{upstream}..HEAD" 2>/dev/null || echo "0")

            if [ "$UNPUSHED" -gt 0 ]; then
                echo -e "${RED}✗ $submodule: $UNPUSHED unpushed commit(s)${NC}"
                NEEDS_PUSH=1
            else
                echo -e "${GREEN}✓ $submodule: in sync${NC}"
            fi
        fi

        popd > /dev/null
    fi
done

if [ "$NEEDS_PUSH" -eq 1 ]; then
    echo ""
    echo -e "${RED}ERROR: Submodules have unpushed commits!${NC}"
    echo ""
    echo "Push submodules first:"
    for submodule in "${CRITICAL_SUBMODULES[@]}"; do
        echo "  cd $submodule && git push && cd .."
    done
    echo ""
    echo "Or use: git push --recurse-submodules=on-demand"
    exit 1
fi

echo "All submodules in sync."
exit 0
